<!DOCTYPE html>
<html>
<head>
	<title>1 / (N+1) Voting Calculator</title>
	<meta charset="UTF-8">
	<style type="text/css">
		body {
			background-color: black;
		}
		main {
			width: 75%;
			text-align: center;
			border: 1px black solid;
			border-radius: 0.5em;
			margin: auto;
			background-color: #f1f1f1;
		}
		#input {
			width: 50%;
			height: 350px;
		}
		#result {
			width: 75%;
			height: 350px;
		}
	</style>
</head>
	<script>
if (window.location.protocol != "https:"){ //force https
    window.location.protocol = "https";
}
</script>
<body>
	<main>
		<h1>SGDC Game Jam 1/(N+1) Voting Calculator</h1>

		<p>This voting calculator will take a .csv file generated by a Google Form with the first five questions being dropdown menus containing game names. It will look at these top 5 placements and award each game 1/(N+1) points. IE, if a game is voted for 1st place, it gets 1/(1+1) = 1/2 points. 2nd gets 1/3 points, etc. These are tallied and the final result displayed below.</p>
		<p>Option Strict means if a ballot contains the same vote twice, completely remove that ballot. If it's off, duplicate votes are simply ignored, and the highest vote is cast.</p>
		<p>Please paste your .csv text into the textfield below, then press the Calculate button. If you're unsure what it should look like, a sample CSV text has been printed out to the browser console.</p>
		<textarea id="input"></textarea> <br>

		<button onclick="calculate()">Calculate</button> <label>Option Strict:</label><input id="checkBox" type="checkbox" checked>

		<br /><br />

		<textarea id="result"></textarea>
	</main>
</body>

<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="jquery.csv.min.js"></script>

<script type="text/javascript">

	function calculate() {
		let numPlacements = 5;
		console.log("time to calculate");
		let str = document.getElementById("input").value;
		let arr = $.csv.toArrays(str);
		let strict = document.getElementById("checkBox").value;
		
		arr.splice(0, 1); //remove header
		let parsedBallots = [];
		for (let i = 0; i < arr.length; i++) {
			//remove timestamp from each entry
			arr[i].splice(0, 1);

			//check for duplicate votes. If strict, invalidate entire ballot. Else, just invalidate those specific ones
			let votes = [];
			for (let j = 0; j < numPlacements; j++) {
				if (votes.indexOf(arr[i][j] == -1)) {
					votes.push(arr[i][j]);
				} else {
					//duplicate
					if (strict) {
						votes = []
						for (let k = 0; k < numPlacements; k++) {
							votes.push("BAD_BALLOT");
						}
						break;
					} else {
						votes.push("BAD_BALLOT");
					}
				}
			}
			parsedBallots.push(votes);
		}

		let gameScores = {};
		for (let i = 0; i < parsedBallots.length; i++) {
			for (let j = 0; j < parsedBallots[i].length; j++) {
				if (!(parsedBallots[i][j] in gameScores)) {
					gameScores[parsedBallots[i][j]] = 1 / (j + 2); //off by 1 for zero index
				} else {
					gameScores[parsedBallots[i][j]] += 1 / (j + 2);
				}
			}
		}

		let sortable = [];
		for (let game in gameScores) {
			if (game != "" && game != undefined && game != "undefined")
		    	sortable.push([game, gameScores[game]]);
		}

		sortable.sort(function(a, b) {
		    return b[1] - a[1];
		});

		let resultsString = "RESULTS:\n\n";
		for (let i = 1; i <= sortable.length; i++) {
			resultsString += i.toString() + " | " + sortable[i - 1][0] + ": " + sortable[i - 1][1] + "\n";
		}
		document.getElementById("result").value = resultsString;
	}
	console.log("Example CSV:");
	console.log("\"Timestamp\",\"1st Place Preference\",\"2nd Place Preference\",\"3rd Place Preference\",\"4th Place Preference\",\"5th Place Preference\",\"Best Audio Design\",\"Best Visual Design\",\"Best Use of Theme\"\n\
\"2017/11/10 9:45:32 PM EST\",\"Game A\",\"Game B\",\"Game C\",\"\",\"\",\"Game D\",\"Game E\",\"Game C\"\n\
\"2017/11/10 9:45:43 PM EST\",\"Game Z\",\"Game A\",\"Game E\",\"Game F\",\"Game B\",\"Game G\",\"Game D\",\"Game 2\"");

</script>

</html>
